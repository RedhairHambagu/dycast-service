server {
    listen 80;
    server_name localhost;
    
    # Gzip 压缩配置
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss 
               application/rss+xml font/truetype font/opentype 
               application/vnd.ms-fontobject image/svg+xml;

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        root /usr/share/nginx/html;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # 主页面
    location / {
        root /usr/share/nginx/html;
        index index.html index.htm;
        try_files $uri $uri/ /index.html;
        add_header Cache-Control "no-cache";
    }

    # 抖音直播接口代理
    location /dylive {
        proxy_pass https://live.douyin.com/;
        
        proxy_buffer_size 64k;
        proxy_buffers 32 64k;
        proxy_busy_buffers_size 128k;

        proxy_set_header Host live.douyin.com;
        proxy_set_header Referer 'https://live.douyin.com/';
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # 移动端 UA 处理
        set $ua $http_user_agent;
        if ($http_user_agent ~* "(iphone|ipad|android|mobile)") {
            set $ua "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.0.0 Safari/537.36 Edg/136.0.0.0";
        }
        proxy_set_header User-Agent $ua;

        # Cookie 处理
        proxy_cookie_domain ~.* $host;
        proxy_cookie_path / /;
        proxy_pass_header Set-Cookie;

        rewrite ^/dylive/(.*) /$1 break;
    }

    # WebSocket 代理
    location /socket {
        proxy_pass https://webcast5-ws-web-lf.douyin.com/;
        
        # WebSocket 配置
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        proxy_set_header Origin https://live.douyin.com;
        proxy_set_header Host webcast5-ws-web-lf.douyin.com;
        proxy_set_header Cookie $http_cookie;
        
        set $ua $http_user_agent;
        if ($http_user_agent ~* "(iphone|ipad|android|mobile)") {
            set $ua "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.0.0 Safari/537.36 Edg/136.0.0.0";
        }
        proxy_set_header User-Agent $ua;

        rewrite ^/socket/(.*) /$1 break;
    }
}
